<html>
<head>
    <meta charset="UTF-8">
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/libraries/p5.js"></script>
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/libraries/p5.dom.js"></script>
    <!--<script language="javascript" src="libraries/p5.sound.js"></script>-->
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/sketch.js"></script>
    <script language="javascript" type="text/javascript" src="../js/gradients.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breatheCalculations.js"></script>
    <script language="javascript" type="text/javascript" src="../js/progress.js"></script>
    <script language="javascript" type="text/javascript" src="../js/countdown.js"></script>
    <script language="javascript" type="text/javascript" src="../js/buttonBar.js"></script>
    <!-- this line removes any default padding and style. you might only need one of these values set. -->
    <link rel="stylesheet" type="text/css" href="../assets/css/breathe.css">

</head>
<body>
<div id="mainDiv">
</div>
<script>

    var maxWidth = 400;
    var startWidth = 50;
    var minHeight = startWidth;
    const buttonDivHeight = 50;

    const textInhale = "Breathe in";
    const textExhale = "Breathe out";
    const textHold = "Hold";

    var totalTime = 120;
    var ballWidth = startWidth;
    var ballHeight = minHeight;
    var dir = 1;
    var distPerFrame;

    var breathingInterval;

    function Breathing(time, text, inhaleTime, exhaleTime) {
        this.time = time;
        this.text = text;
        this.maxTextSize = 20;
        this.textSize = this.maxTextSize;
        this.interval = 125;
        this.step = 0.125;
        this.inhaleTime = inhaleTime;
        this.exhaleTime = exhaleTime;
        this.breathePause = 3;
    }

    function Counter() {
        this.counter = 0;
        this.interval = null;
        this.fun = null;
    }

    Counter.prototype.start = function (fun) {
        this.interval = setInterval(fun, 1000);
        this.fun = fun;
    };

    Counter.prototype.reset = function () {
        clearInterval(this.interval);
        this.counter = 0;
        this.start(this.fun);
    };

    var standardBreathing = new Breathing(totalTime, textInhale, 5, 5);

    var countDown = new CountDown(standardBreathing.breathePause);

    var counter = new Counter();

    var progress;

    var buttonBar = new ButtonBar();


    function setup() {

        window.onblur = function () {
            stopAnimation();
        };

        calcMaxSize();
        var canvas = createBreathingCanvas();
        initProgress(canvas);

        updateTimer();

        buttonBar.createButtons();

        window.onresize = function () { // Adapt the layout on resize
            canvas.size(window.innerWidth, window.innerHeight - buttonDivHeight);
            maxWidth = calcMaxWidth(window.innerWidth, window.innerHeight);
        };

        counter.start(function () {
            this.counter.counter++;
        });

    }
    function draw() {
        distPerFrame = calcFrameRate();
        const gradientColors = {
            startBack: color(0x3c, 0x5d, 0xa0),
            endBack: color(0xff),
            drawBack: function () {
                gradients.setGradient(0, 0, width, height, gradientColors.startBack, gradientColors.endBack, gradients.Y_AXIS);
            }
        };
        gradientColors.drawBack();

        translate(width * 0.5, height * 0.5);

        noStroke();

        animateEllipse();

        progress.fillProgress(width);

        fillText();
    }

    var createBreathingCanvas = function () {
        var canvas = createCanvas(window.innerWidth, window.innerHeight - buttonDivHeight);
        canvas.parent("#mainDiv");
        return canvas;
    };

    var initProgress = function (canvas) {
        progress = new Progress(0, standardBreathing.time, canvas.width);
        progress.setProgressbarGraphics(createGraphics(canvas.width, progress.progressHeight));
    };

    var calcMaxWidth = function (width, height) {
        return width > height ? height - 150 : width - 150;
    };

    var calcMaxSize = function () {
        maxWidth = calcMaxWidth(window.innerWidth, window.innerHeight);
        startWidth = ballWidth = ballHeight = minHeight = maxWidth - 100;
    };

    var fillText = function () {

        textSize(standardBreathing.textSize);
        fill(255);
        textAlign(CENTER, BOTTOM);
        const printedText = text(standardBreathing.text, 0, 0);
        text(counter.counter, 0, -100);
    };

    var animateEllipse = function () {
        if (ballWidth > maxWidth) {
            waitAfterInhale();
        }
        else if (ballHeight < minHeight) {
            waitAfterExhale();
        }
        incrementDecrement();
        gradients.gradialRadient(0, 0, color(255), color(0x3c, 0x5d, 0xa0), ballWidth / 2);
    };

    var stopAnimation = function () {
        clearInterval(breathingInterval);
        noLoop();
    };

    var restartAnimation = function (inhaleTime, exhaleTime) {

        calcMaxSize();
        var canvas = createBreathingCanvas();
        initProgress(canvas);
        dir = 1;
        stopAnimation();
        standardBreathing = new Breathing(totalTime, textInhale, inhaleTime, exhaleTime);
        counter.reset();
        loop();
        updateTimer();
    };

    var updateTimer = function () {
        breathingInterval = setInterval(function () {
            standardBreathing.time -= standardBreathing.step;
            var number = standardBreathing.time;
            progress = new Progress(number, totalTime, width, progress.progressbarGraphics);
            if (number < 0) {
                clearInterval(breathingInterval);
                noLoop();
            }
        }, standardBreathing.interval);
    };

    var incrementDecrement = function () {
        ballWidth += dir * distPerFrame;
        ballHeight += dir * distPerFrame;
    };

    var calcFrameRate = function () {
        return breatheCalculations.calcDistance(standardBreathing.exhaleTime, maxWidth - startWidth, frameRate() == 0 ? 60 : frameRate());
    };

    var waitAfterInhale = function () {
        countDown.callback(function () {
            dir = -1;
            standardBreathing.text = textExhale;
            counter.reset();
            setTimeout(function () {
                countDown = new CountDown(standardBreathing.breathePause)
            }, 1000);
        }, function () {
            dir = 0;
            standardBreathing.text = textHold;
        });
    };

    var waitAfterExhale = function () {
        countDown.callback(function () {
            dir = 1;
            standardBreathing.text = textInhale;
            counter.reset();
            setTimeout(function () {
                countDown = new CountDown(standardBreathing.breathePause)
            }, 1000);
        }, function () {
            dir = 0;
            standardBreathing.text = textHold;
        });
    };

</script>


</body>
</html>