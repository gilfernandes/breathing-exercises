<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/libraries/p5.js"></script>
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/libraries/p5.dom.js"></script>
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/libraries/p5.sound.js"></script>

    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/sketch.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/gradients.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/breatheCalculations.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/progress.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/buttonBar.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/soundPlayer.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/counter.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/breatheText.js"></script>
    <!-- this line removes any default padding and style. you might only need one of these values set. -->
    <link rel="stylesheet" type="text/css" href="../assets/css/breathe.css">

</head>
<body>
<div id="mainDiv">
</div>
<script>

    var startWidth = 50;
    const buttonDivHeight = 50;

    const textInhale = "Breathe in";
    const textExhale = "Breathe out";
    const textHold = "Hold";

    var totalTime = 120;
    var distPerFrame;

    var breathingInterval;

    var breatheText;

    var ctx;

    function Breathing(time, text, inhaleTime, exhaleTime) {
        this.time = time;
        this.text = text;
        this.maxTextSize = 20;
        this.textSize = this.maxTextSize;
        this.interval = 125;
        this.step = 0.125;
        this.inhaleTime = inhaleTime;
        this.exhaleTime = exhaleTime;
        this.breathePause = 3;
    }

    function BreathBall(width, maxWidth) {
        this.width = width;
        this.dir = 1;
        this.maxWidth = maxWidth;
    }

    BreathBall.prototype.move = function () {
        const active = this.dir !== 0;
        if ((this.width > this.maxWidth || counter.counter > standardBreathing.inhaleTime) && active) {
            waitAfterInhale();
        }
        else if ((this.width < startWidth || counter.counter > standardBreathing.inhaleTime) && active) {
            waitAfterExhale();
        }
        this.incrementDecrement();
    };

    BreathBall.prototype.reduceSize = function () {
        this.width = this.maxWidth - 1;
    };

    BreathBall.prototype.augmentSize = function () {
        this.width = startWidth + 2;
    };

    BreathBall.prototype.incrementDecrement = function () {
        if (this.dir !== 0) {
            this.width += this.dir * distPerFrame;
        }
    };

    BreathBall.prototype.display = function () {

        var rotation1 = map(50, 0, 100, 0, this.width);
        var rotation2 = map(50, 0, 100, 0, this.width);
        var location = map(50, 0, 100, 0, this.width);
        var sizeEllipse = this.width / 2;
        var xEllipse = 0;
        var yEllipse = 0;

        var startGrad = createVector(xEllipse - sizeEllipse / 2 + rotation1 + location, yEllipse + sizeEllipse / 2 - rotation2 - location);
        var endGrad = createVector(xEllipse + sizeEllipse / 2 - rotation1 - location, yEllipse - sizeEllipse / 2 + rotation2 + location);

        //ellipse
        var gradient = ctx.createLinearGradient(startGrad.x, startGrad.y, endGrad.x, endGrad.y);
        gradient.addColorStop(0, "#3c5da0");
        gradient.addColorStop(1, "#ffffff");
        ctx.beginPath();
        ctx.ellipse(xEllipse, yEllipse, sizeEllipse, sizeEllipse, 45 * Math.PI / 180, 0, 2 * Math.PI);
        ctx.fillStyle = gradient;
        ctx.fill();
    };

    var breathBall;

    var standardBreathing = new Breathing(totalTime, textInhale, 4, 4);

    var counter = new Counter();

    var progress;

    var buttonBar = new ButtonBar(standardBreathing.inhaleTime, standardBreathing.exhaleTime);

    var player;

    function preload() {
        player = new Player(["../assets/sound/e_eyesee_word_of_silence_track_07.ogg",
            "../assets/sound/e_jewel_purpose_track_06.ogg"]);
    }

    var startCounter = function () {
        counter.start(function () {
            counter.counter++;
        });
    };

    function setup() {

        calcMaxSize();

        var canvas = createBreathingCanvas();
        ctx = canvas.drawingContext;
        initProgress(canvas);

        updateTimer();

        buttonBar.createButtons();

        window.onresize = function () { // Adapt the layout on resize
            canvas.size(window.innerWidth, window.innerHeight - buttonDivHeight);
            breathBall.maxWidth = calcMaxWidth(window.innerWidth, window.innerHeight);
        };

        startCounter();

        player.playRandom();

        breatheText = new BreatheText(255, standardBreathing.textSize, CENTER, CENTER);
    }

    function draw() {
        distPerFrame = calcFrameRate();

        background(color(0x3c, 0x5d, 0xa0));

        translate(width * 0.5, height * 0.5);

        noStroke();

        breathBall.move();

        breathBall.display();

        progress.fillProgress(width);

        fillText();
    }

    var createBreathingCanvas = function () {
        var canvas = createCanvas(window.innerWidth, window.innerHeight - buttonDivHeight);
        canvas.parent("#mainDiv");
        return canvas;
    };

    var initProgress = function (canvas) {
        progress = new Progress(0, standardBreathing.time, canvas.width);
        progress.setProgressbarGraphics(createGraphics(canvas.width, progress.progressHeight));
    };

    var calcMaxWidth = function (width, height) {
        return width > height ? height - 150 : width - 150;
    };

    var calcMaxSize = function () {
        var maxWidth = calcMaxWidth(window.innerWidth, window.innerHeight);
        startWidth = maxWidth - 100;
        breathBall = new BreathBall(startWidth, maxWidth);
    };

    var fillText = function () {

        breatheText.print(standardBreathing.text);
        text(counter.counter, 0, -100);
    };

    var stopAnimation = function () {
        clearInterval(breathingInterval);
        counter.stop();
        noLoop();
    };

    var restartAnimation = function (inhaleTime, exhaleTime) {

        var canvas = createBreathingCanvas();
        initProgress(canvas);
        breathBall.dir = 1;
        stopAnimation();
        standardBreathing = new Breathing(totalTime, textInhale, inhaleTime, exhaleTime);
        calcMaxSize();
        loop();
        updateTimer();
        player.restartRandom();
        startCounter();
    };

    var updateTimer = function () {
        breathingInterval = setInterval(function () {
            standardBreathing.time -= standardBreathing.step;
            var number = standardBreathing.time;
            progress = new Progress(number, totalTime, width, progress.progressbarGraphics);
            if (number < 0) {
                clearInterval(breathingInterval);
                noLoop();
            }
        }, standardBreathing.interval);
    };

    var calcFrameRate = function () {
        const frameR = frameRate();
        return breatheCalculations.calcDistance(standardBreathing.exhaleTime, breathBall.maxWidth - startWidth, (frameR | 0) === 0 ? 60 : frameR);
    };

    var waitAfterInhale = function () {
        standardBreathing.text = textHold;
        breathBall.dir = 0;
        setTimeout(function () {
            counter.reset();
            breathBall.dir = -1;
            breathBall.reduceSize();
            standardBreathing.text = textExhale;
        }, standardBreathing.breathePause * 1000);
    };

    var waitAfterExhale = function () {
        standardBreathing.text = textHold;
        breathBall.dir = 0;
        setTimeout(function () {
            counter.reset();
            breathBall.dir = 1;
            breathBall.augmentSize();
            standardBreathing.text = textInhale;
        }, standardBreathing.breathePause * 1000);
    };

</script>


</body>
</html>