<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/libraries/p5.js"></script>
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/libraries/p5.dom.js"></script>
    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/libraries/p5.sound.js"></script>

    <script language="javascript" type="text/javascript" src="../js/p5/empty-example/sketch.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/gradients.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/breatheBall.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/breatheCalculations.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/progress.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/buttonBar.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/soundPlayer.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/counter.js"></script>
    <script language="javascript" type="text/javascript" src="../js/breathe/breatheText.js"></script>
    <script language="javascript" type="text/javascript" src="../js/common/sprite.js"></script>
    <!-- this line removes any default padding and style. you might only need one of these values set. -->
    <link rel="stylesheet" type="text/css" href="../assets/css/breathe.css">

</head>
<body>
<div id="mainDiv">
</div>
<script>

    let startWidth = 50; // TODO: put this variable into the BreatheBall class.
    const buttonDivHeight = 50;

    const textInhale = "Breathe in";
    const textExhale = "Breathe out";
    const textHold = "Hold";

    let totalTime = 120;
    let distPerFrame;

    let breathingInterval;

    let breatheText;

    let ctx;

    function Breathing(time, text, inhaleTime, exhaleTime) {
        this.time = time;
        this.text = text;
        this.maxTextSize = window.innerWidth < 1024 ? 64 : 24;
        this.textSize = this.maxTextSize;
        this.interval = 125;
        this.step = 0.125;
        this.inhaleTime = inhaleTime;
        this.exhaleTime = exhaleTime;
        this.breathePause = 3;
    }

    let breathBall;

    let standardBreathing = new Breathing(totalTime, textInhale, 4, 4);

    let counter = new Counter();

    let progress;

    let buttonBar = new ButtonBar(standardBreathing.inhaleTime, standardBreathing.exhaleTime);

    let player;

    function preload() {
        player = new Player(["../assets/sound/e_eyesee_word_of_silence_track_07.ogg",
            "../assets/sound/e_jewel_purpose_track_06.ogg"]);
    }

    let startCounter = function () {
        counter.start(function () {
            counter.counter++;
        });
    };

    function setup() {

        createBreatheBall();

        let canvas = createBreathingCanvas();
        ctx = canvas.drawingContext;
        initProgress(canvas);

        updateTimer();

        buttonBar.createButtons();

        window.onresize = function () { // Adapt the layout on resize
            canvas.size(window.innerWidth, window.innerHeight - buttonDivHeight);
            breathBall.maxWidth = calcMaxWidth(window.innerWidth, window.innerHeight);
        };

        startCounter();

        player.playRandom();

        breatheText = new BreatheText(color(0x4b, 0xc6, 0xd5), standardBreathing.textSize, CENTER, CENTER, 0,
            - window.innerHeight / 3);
    }

    function draw() {
        distPerFrame = calcFrameRate();

        background(color(0xff, 0xff, 0xff));

        translate(width * 0.5, height * 0.5);

        noStroke();

        breathBall.move();

        breathBall.displayImage();

        progress.fillProgress(width);

        breatheText.displayText(standardBreathing.text);
    }

    let createBreathingCanvas = function () {
        let canvas = createCanvas(window.innerWidth, window.innerHeight - buttonDivHeight);
        canvas.parent("#mainDiv");
        return canvas;
    };

    let initProgress = function (canvas) {
        progress = new Progress(0, standardBreathing.time, canvas.width);
        progress.setProgressbarGraphics(createGraphics(canvas.width, progress.progressHeight));
    };

    let calcMaxWidth = function (width, height) {
        const widthBiggerHeight = width > height;
        return widthBiggerHeight ? height : width;
    };

    let createBreatheBall = function () {
        let maxWidth = calcMaxWidth(window.innerWidth, window.innerHeight);
        startWidth = maxWidth - maxWidth * 0.3;
        breathBall = new BreathBall(startWidth, maxWidth);
    };

    let stopAnimation = function () {
        clearInterval(breathingInterval);
        counter.stop();
        noLoop();
    };

    var restartAnimation = function (inhaleTime, exhaleTime) {

        var canvas = createBreathingCanvas();
        initProgress(canvas);
        breathBall.dir = 1;
        stopAnimation();
        standardBreathing = new Breathing(totalTime, textInhale, inhaleTime, exhaleTime);
        createBreatheBall();
        loop();
        updateTimer();
        player.restartRandom();
        startCounter();
    };

    var updateTimer = function () {
        breathingInterval = setInterval(function () {
            standardBreathing.time -= standardBreathing.step;
            var number = standardBreathing.time;
            progress = new Progress(number, totalTime, width, progress.progressbarGraphics);
            if (number < 0) {
                clearInterval(breathingInterval);
                noLoop();
            }
        }, standardBreathing.interval);
    };

    var calcFrameRate = function () {
        const frameR = frameRate();
        return breatheCalculations.calcDistance(standardBreathing.exhaleTime, breathBall.maxWidth - startWidth, (frameR | 0) === 0 ? 60 : frameR);
    };

    var waitAfterInhale = function () {
        standardBreathing.text = textHold;
        breathBall.dir = 0;
        setTimeout(function () {
            counter.reset();
            breathBall.dir = -1;
            breathBall.reduceSize();
            standardBreathing.text = textExhale;
        }, standardBreathing.breathePause * 1000);
    };

    var waitAfterExhale = function () {
        standardBreathing.text = textHold;
        breathBall.dir = 0;
        setTimeout(function () {
            counter.reset();
            breathBall.dir = 1;
            breathBall.augmentSize();
            standardBreathing.text = textInhale;
        }, standardBreathing.breathePause * 1000);
    };

</script>


</body>
</html>